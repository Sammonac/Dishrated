<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Reflections</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* Auth Screen Styles */
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #007AFF, #0056b3);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .auth-screen.hidden {
            display: none;
        }

        .auth-content {
            background: white;
            border-radius: 12px;
            padding: 60px 40px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
            max-width: 400px;
            width: 100%;
            margin: 20px;
        }

        .auth-content h1 {
            margin-bottom: 10px;
            color: #1a1a1a;
            font-size: 2rem;
        }

        .auth-content p {
            color: #666;
            margin-bottom: 40px;
            line-height: 1.6;
        }

        .google-sign-in-btn {
            background: white;
            border: 2px solid #e9ecef;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            font-weight: 500;
        }

        .google-sign-in-btn:hover {
            border-color: #007AFF;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.2);
        }

        .google-sign-in-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .google-icon {
            width: 20px;
            height: 20px;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
            z-index: 2500;
        }

        .loading-screen.hidden {
            display: none;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e9ecef;
            border-top: 4px solid #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 0.9rem;
            text-align: left;
        }

        .header {
            background: white;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .nav-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .nav-btn:hover {
            background: #0056b3;
        }

        .nav-btn.active {
            background: #34C759;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-name {
            font-size: 0.9rem;
            color: #333;
            font-weight: 500;
        }

        .logout-btn {
            background: #e9ecef;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            color: #333;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
        }

        .logout-btn:hover {
            background: #dee2e6;
        }

        .main-app {
            opacity: 1;
            transition: opacity 0.3s;
        }

        .main-app.hidden {
            display: none;
        }

        .screen {
            display: none;
            padding: 30px 20px;
        }

        .screen.active {
            display: block;
        }

        .screen-title {
            font-size: 24px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 30px;
            color: #1a1a1a;
        }

        .rating-group {
            margin-bottom: 25px;
        }

        .rating-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 500;
            font-size: 16px;
        }

        .slider-container {
            position: relative;
            margin-bottom: 15px;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #e9ecef;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #007AFF;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #007AFF;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .slider-value {
            text-align: center;
            margin-top: 5px;
            font-weight: 600;
            color: #007AFF;
        }

        .text-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
            margin-bottom: 20px;
        }

        .text-input:focus {
            outline: none;
            border-color: #007AFF;
        }

        .optional-section {
            margin: 20px 0;
            text-align: center;
        }

        .optional-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 15px;
        }

        .optional-btn {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .optional-btn:hover {
            border-color: #007AFF;
            background: #f0f8ff;
        }

        .emoji-picker {
            display: none;
            margin-top: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            text-align: center;
        }

        .emoji-picker.active {
            display: block;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .emoji-btn {
            background: none;
            border: none;
            font-size: 24px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .emoji-btn:hover {
            background: #e9ecef;
        }

        .save-btn {
            width: 100%;
            background: #34C759;
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.3s;
        }

        .save-btn:hover {
            background: #28a745;
        }

        .save-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .summary-stats {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-row:last-child {
            margin-bottom: 0;
        }

        .stat-bar {
            flex: 1;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin: 0 15px;
            overflow: hidden;
        }

        .stat-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .stat-fill.health { background: #34C759; }
        .stat-fill.wealth { background: #FF9500; }
        .stat-fill.love { background: #FF2D92; }

        .summary-text {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            line-height: 1.8;
        }

        .daily-entries {
            margin-top: 20px;
        }

        .daily-entry {
            padding: 15px;
            border-left: 4px solid #007AFF;
            background: #f8f9fa;
            margin-bottom: 15px;
            border-radius: 0 8px 8px 0;
        }

        .entry-date {
            font-weight: 600;
            color: #007AFF;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .entry-text {
            font-style: italic;
            margin-bottom: 10px;
        }

        .entry-ratings {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #666;
        }

        .current-date {
            font-size: 16px;
            color: #666;
        }

        .selected-emoji {
            margin-left: 10px;
            font-size: 20px;
        }

        .no-entries {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px 20px;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .auth-content {
                padding: 40px 30px;
            }

            .optional-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .nav-btn {
                font-size: 12px;
                padding: 6px 12px;
            }

            .user-info {
                font-size: 0.8rem;
            }

            .logout-btn {
                font-size: 0.8rem;
                padding: 6px 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-screen">
        <div class="auth-content">
            <h1>Daily Reflections</h1>
            <p>Track your daily journey across Health, Wealth, and Love. Sign in with Google to sync your reflections across all devices.</p>
            <button id="googleSignInBtn" class="google-sign-in-btn">
                <svg class="google-icon" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Continue with Google
            </button>
            <div id="authError" class="error-message hidden"></div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen hidden">
        <div class="spinner"></div>
        <p>Loading your reflections...</p>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="main-app hidden">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <button class="nav-btn active" id="dailyBtn">Daily Entry</button>
                <div class="current-date" id="currentDate"></div>
                <button class="nav-btn" id="summaryBtn">Weekly Summary</button>
                <div id="userInfo" class="user-info">
                    <img id="userAvatar" class="user-avatar" alt="Profile">
                    <span id="userName" class="user-name"></span>
                </div>
                <button id="logoutBtn" class="logout-btn">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                    Logout
                </button>
            </div>

            <!-- Daily Entry Screen -->
            <div class="screen active" id="dailyScreen">
                <h2 class="screen-title">How was your day?</h2>
                
                <div class="rating-group">
                    <div class="rating-label">
                        <span>üò∑ Health</span>
                        <span>üòä</span>
                    </div>
                    <div class="slider-container">
                        <input type="range" min="1" max="10" value="5" class="slider" id="healthSlider">
                        <div class="slider-value" id="healthValue">5</div>
                    </div>
                </div>

                <div class="rating-group">
                    <div class="rating-label">
                        <span>üí∏ Wealth</span>
                        <span>üí∞</span>
                    </div>
                    <div class="slider-container">
                        <input type="range" min="1" max="10" value="5" class="slider" id="wealthSlider">
                        <div class="slider-value" id="wealthValue">5</div>
                    </div>
                </div>

                <div class="rating-group">
                    <div class="rating-label">
                        <span>üíî Love</span>
                        <span>‚ù§Ô∏è</span>
                    </div>
                    <div class="slider-container">
                        <input type="range" min="1" max="10" value="5" class="slider" id="loveSlider">
                        <div class="slider-value" id="loveValue">5</div>
                    </div>
                </div>

                <textarea class="text-input" id="dailyText" placeholder="One sentence about today..."></textarea>

                <div class="optional-section">
                    <p>Optional:</p>
                    <div class="optional-buttons">
                        <button class="optional-btn" id="emojiBtn">üòä Add Mood</button>
                        <input type="file" id="photoInput" accept="image/*" style="display: none;">
                        <button class="optional-btn" id="photoBtn">üì∑ Photo</button>
                    </div>
                    
                    <div class="emoji-picker" id="emojiPicker">
                        <p>Select your mood:</p>
                        <div class="emoji-grid">
                            <button class="emoji-btn" data-emoji="üòä">üòä</button>
                            <button class="emoji-btn" data-emoji="üò¢">üò¢</button>
                            <button class="emoji-btn" data-emoji="üò¥">üò¥</button>
                            <button class="emoji-btn" data-emoji="ü•≥">ü•≥</button>
                            <button class="emoji-btn" data-emoji="üòå">üòå</button>
                            <button class="emoji-btn" data-emoji="üò§">üò§</button>
                            <button class="emoji-btn" data-emoji="ü§ó">ü§ó</button>
                            <button class="emoji-btn" data-emoji="üòé">üòé</button>
                            <button class="emoji-btn" data-emoji="ü§î">ü§î</button>
                            <button class="emoji-btn" data-emoji="üòá">üòá</button>
                        </div>
                    </div>
                </div>

                <button class="save-btn" id="saveBtn">Save Entry</button>
            </div>

            <!-- Weekly Summary Screen -->
            <div class="screen" id="summaryScreen">
                <h2 class="screen-title">Your Week at a Glance</h2>
                
                <div class="summary-stats" id="summaryStats">
                    <div class="stat-row">
                        <span>Health</span>
                        <div class="stat-bar">
                            <div class="stat-fill health" id="healthBar"></div>
                        </div>
                        <span id="healthAvg">0</span>
                    </div>
                    <div class="stat-row">
                        <span>Wealth</span>
                        <div class="stat-bar">
                            <div class="stat-fill wealth" id="wealthBar"></div>
                        </div>
                        <span id="wealthAvg">0</span>
                    </div>
                    <div class="stat-row">
                        <span>Love</span>
                        <div class="stat-bar">
                            <div class="stat-fill love" id="loveBar"></div>
                        </div>
                        <span id="loveAvg">0</span>
                    </div>
                </div>

                <div class="summary-text" id="summaryText">
                    Your weekly reflection will appear here...
                </div>

                <div class="daily-entries" id="dailyEntries">
                    <h3>Daily Snapshots</h3>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signInWithRedirect,
            getRedirectResult,
            signOut, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            collection, 
            getDocs,
            deleteDoc,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // Firebase configuration - REPLACE WITH YOUR CONFIG
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.firebasestorage.app",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Configure Google Auth Provider
        const provider = new GoogleAuthProvider();
        provider.addScope('profile');
        provider.addScope('email');

        // Global variables
        let entries = [];
        let currentUser = null;
        let selectedEmoji = '';

        // DOM elements
        const authScreen = document.getElementById('authScreen');
        const loadingScreen = document.getElementById('loadingScreen');
        const mainApp = document.getElementById('mainApp');
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const authError = document.getElementById('authError');

        // Utility function to detect mobile devices
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                   (navigator.maxTouchPoints && navigator.maxTouchPoints > 1) ||
                   window.innerWidth <= 768;
        }

        // Initialize the app
        function initApp() {
            console.log('üöÄ Initializing Daily Reflections app...');
            console.log('üì± Mobile device detected:', isMobileDevice());
            
            try {
                showLoadingScreen(); // Show loading first to handle redirect result
                
                // Check for redirect result first (important for mobile)
                handleRedirectResult();
                
                // Set up auth state listener
                onAuthStateChanged(auth, async (user) => {
                    console.log('üîê Auth state changed:', user ? `${user.email} (${user.uid})` : 'No user');
                    
                    if (user) {
                        currentUser = user;
                        showLoadingScreen();
                        try {
                            await loadUserData();
                            showMainApp();
                        } catch (error) {
                            console.error('‚ùå Error loading user data:', error);
                            showMainApp(); // Show app even if data loading fails
                        }
                    } else {
                        currentUser = null;
                        showAuthScreen();
                    }
                });

                setupEventListeners();
                
                console.log('‚úÖ App initialization complete');
                
            } catch (error) {
                console.error('üí• App initialization error:', error);
                showAuthError(`App initialization failed: ${error.message}`);
            }
        }

        // Handle redirect result for mobile sign-in
        async function handleRedirectResult() {
            try {
                console.log('üîÑ Checking for redirect result...');
                const result = await getRedirectResult(auth);
                
                if (result) {
                    console.log('‚úÖ Redirect sign-in successful:', result.user.displayName || result.user.email);
                    // User will be handled by onAuthStateChanged
                } else {
                    console.log('üìù No redirect result found');
                }
            } catch (error) {
                console.error('‚ùå Redirect result error:', error);
                showAuthError(`Sign-in failed: ${error.message}`);
                showAuthScreen();
            }
        }

        function showAuthScreen() {
            console.log('üì± Showing auth screen');
            authScreen.classList.remove('hidden');
            loadingScreen.classList.add('hidden');
            mainApp.classList.add('hidden');
        }

        function showLoadingScreen() {
            console.log('‚è≥ Showing loading screen');
            authScreen.classList.add('hidden');
            loadingScreen.classList.remove('hidden');
            mainApp.classList.add('hidden');
        }

        function showMainApp() {
            console.log('üéâ Showing main app');
            authScreen.classList.add('hidden');
            loadingScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
            
            // Update user info
            document.getElementById('userAvatar').src = currentUser.photoURL || '';
            document.getElementById('userName').textContent = currentUser.displayName || currentUser.email || 'User';
            
            // Initialize app components
            updateCurrentDate();
            checkForTodaysEntry();
            initializeSliders();
        }

        function setupEventListeners() {
            // Auth listeners
            googleSignInBtn.addEventListener('click', signInWithGoogle);
            logoutBtn.addEventListener('click', signOutUser);

            // Navigation
            document.getElementById('dailyBtn').addEventListener('click', () => switchScreen('daily'));
            document.getElementById('summaryBtn').addEventListener('click', () => switchScreen('summary'));

            // Daily entry
            document.getElementById('saveBtn').addEventListener('click', saveEntry);
            document.getElementById('emojiBtn').addEventListener('click', toggleEmojiPicker);
            document.getElementById('photoBtn').addEventListener('click', () => {
                document.getElementById('photoInput').click();
            });

            // Emoji selection
            document.querySelectorAll('.emoji-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    selectEmoji(this.dataset.emoji);
                });
            });

            // Slider listeners
            initializeSliders();
        }

        async function signInWithGoogle() {
            try {
                console.log('üîë Starting Google Sign-In...');
                console.log('üì± Mobile device:', isMobileDevice());
                
                hideAuthError();
                
                googleSignInBtn.disabled = true;
                googleSignInBtn.textContent = 'Signing in...';
                
                if (isMobileDevice()) {
                    // Use redirect for mobile devices
                    console.log('üì± Using redirect authentication for mobile');
                    await signInWithRedirect(auth, provider);
                    // Note: The page will redirect, so we won't reach this point
                } else {
                    // Use popup for desktop
                    console.log('üñ•Ô∏è Using popup authentication for desktop');
                    const result = await signInWithPopup(auth, provider);
                    console.log('‚úÖ Popup sign-in successful:', result.user.displayName || result.user.email);
                }
                
            } catch (error) {
                console.error('‚ùå Sign-in error:', error);
                
                let errorMessage = 'Failed to sign in with Google. ';
                
                switch (error.code) {
                    case 'auth/popup-blocked':
                        errorMessage += 'Please allow popups for this site or try refreshing the page.';
                        break;
                    case 'auth/popup-closed-by-user':
                        errorMessage += 'Sign-in was cancelled.';
                        break;
                    case 'auth/unauthorized-domain':
                        errorMessage += 'This domain is not authorized. Please contact support.';
                        break;
                    case 'auth/operation-not-allowed':
                        errorMessage += 'Google Sign-In is not enabled.';
                        break;
                    case 'auth/redirect-cancelled-by-user':
                        errorMessage += 'Sign-in was cancelled.';
                        break;
                    case 'auth/redirect-operation-pending':
                        errorMessage += 'Another sign-in is already in progress.';
                        break;
                    default:
                        errorMessage += `Error: ${error.message}`;
                }
                
                showAuthError(errorMessage);
                resetSignInButton();
            }
        }

        function resetSignInButton() {
            googleSignInBtn.disabled = false;
            googleSignInBtn.innerHTML = `
                <svg class="google-icon" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Continue with Google
            `;
        }

        async function signOutUser() {
            try {
                await signOut(auth);
                console.log('Sign-out successful');
                // Reset app state
                entries = [];
                selectedEmoji = '';
            } catch (error) {
                console.error('Sign-out error:', error);
            }
        }

        function showAuthError(message) {
            authError.textContent = message;
            authError.classList.remove('hidden');
        }

        function hideAuthError() {
            authError.classList.add('hidden');
        }

        async function loadUserData() {
            try {
                await loadUserEntries();
                console.log('User data loaded successfully');
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        async function loadUserEntries() {
            try {
                const entriesCollection = collection(db, 'users', currentUser.uid, 'entries');
                const querySnapshot = await getDocs(entriesCollection);
                
                entries = [];
                querySnapshot.forEach((doc) => {
                    const entryData = doc.data();
                    entries.push({
                        id: doc.id,
                        ...entryData,
                        date: entryData.date?.toDate?.()?.toISOString() || entryData.date || new Date().toISOString()
                    });
                });
                
                // Sort by date (newest first)
                entries.sort((a, b) => new Date(b.date) - new Date(a.date));
                console.log('Entries loaded successfully:', entries.length);
            } catch (error) {
                console.error('Error loading entries:', error);
                entries = [];
            }
        }

        async function saveEntryToFirestore(entry) {
            try {
                const entryRef = doc(db, 'users', currentUser.uid, 'entries', entry.id);
                await setDoc(entryRef, {
                    ...entry,
                    date: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });
                console.log('Entry saved successfully:', entry.id);
            } catch (error) {
                console.error('Error saving entry:', error);
                throw error;
            }
        }

        function updateCurrentDate() {
            const today = new Date();
            const options = { month: 'short', day: 'numeric' };
            document.getElementById('currentDate').textContent = today.toLocaleDateString('en-US', options);
        }

        function initializeSliders() {
            const sliders = ['health', 'wealth', 'love'];
            sliders.forEach(type => {
                const slider = document.getElementById(`${type}Slider`);
                const value = document.getElementById(`${type}Value`);
                
                slider.addEventListener('input', function() {
                    value.textContent = this.value;
                });
            });
        }

        function switchScreen(screen) {
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));

            if (screen === 'daily') {
                document.getElementById('dailyBtn').classList.add('active');
                document.getElementById('dailyScreen').classList.add('active');
            } else {
                document.getElementById('summaryBtn').classList.add('active');
                document.getElementById('summaryScreen').classList.add('active');
                generateWeeklySummary();
            }
        }

        function toggleEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            picker.classList.toggle('active');
        }

        function selectEmoji(emoji) {
            selectedEmoji = emoji;
            document.getElementById('emojiBtn').innerHTML = `${emoji} Add Mood`;
            document.getElementById('emojiPicker').classList.remove('active');
        }

        function checkForTodaysEntry() {
            const today = new Date().toDateString();
            const todaysEntry = entries.find(entry => 
                new Date(entry.date).toDateString() === today
            );

            if (todaysEntry) {
                // Pre-fill form with today's entry
                document.getElementById('healthSlider').value = todaysEntry.health;
                document.getElementById('wealthSlider').value = todaysEntry.wealth;
                document.getElementById('loveSlider').value = todaysEntry.love;
                document.getElementById('dailyText').value = todaysEntry.text;
                
                ['health', 'wealth', 'love'].forEach(type => {
                    document.getElementById(`${type}Value`).textContent = todaysEntry[type];
                });

                if (todaysEntry.emoji) {
                    selectedEmoji = todaysEntry.emoji;
                    document.getElementById('emojiBtn').innerHTML = `${todaysEntry.emoji} Add Mood`;
                }

                document.getElementById('saveBtn').textContent = 'Update Entry';
            }
        }

        async function saveEntry() {
            const today = new Date();
            const health = parseInt(document.getElementById('healthSlider').value);
            const wealth = parseInt(document.getElementById('wealthSlider').value);
            const love = parseInt(document.getElementById('loveSlider').value);
            const text = document.getElementById('dailyText').value.trim();

            if (!text) {
                alert('Please write at least one sentence about your day.');
                return;
            }

            const todayString = today.toDateString();
            const entryId = today.toISOString().split('T')[0]; // Use date as ID (YYYY-MM-DD)

            const entry = {
                id: entryId,
                date: today.toISOString(),
                health,
                wealth,
                love,
                text,
                emoji: selectedEmoji
            };

            try {
                // Save to Firestore
                await saveEntryToFirestore(entry);

                // Remove existing entry for today if it exists
                entries = entries.filter(entry => 
                    new Date(entry.date).toDateString() !== todayString
                );

                // Add new entry
                entries.push(entry);
                entries.sort((a, b) => new Date(b.date) - new Date(a.date));

                // Show success feedback
                const btn = document.getElementById('saveBtn');
                const originalText = btn.textContent;
                btn.textContent = 'Saved! ‚úì';
                btn.disabled = true;

                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('Error saving entry:', error);
                alert('Error saving entry. Please try again.');
            }
        }

        function generateWeeklySummary() {
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);

            const weekEntries = entries.filter(entry => 
                new Date(entry.date) >= weekAgo
            );

            if (weekEntries.length === 0) {
                document.getElementById('summaryStats').innerHTML = '<p class="no-entries">No entries this week. Start journaling to see your weekly summary!</p>';
                document.getElementById('summaryText').textContent = 'Write a few daily entries to generate your weekly reflection.';
                document.getElementById('dailyEntries').innerHTML = '<h3>Daily Snapshots</h3><p class="no-entries">No entries yet this week.</p>';
                return;
            }

            // Calculate averages
            const healthAvg = (weekEntries.reduce((sum, entry) => sum + entry.health, 0) / weekEntries.length).toFixed(1);
            const wealthAvg = (weekEntries.reduce((sum, entry) => sum + entry.wealth, 0) / weekEntries.length).toFixed(1);
            const loveAvg = (weekEntries.reduce((sum, entry) => sum + entry.love, 0) / weekEntries.length).toFixed(1);

            // Update stats bars
            document.getElementById('healthAvg').textContent = healthAvg;
            document.getElementById('wealthAvg').textContent = wealthAvg;
            document.getElementById('loveAvg').textContent = loveAvg;

            document.getElementById('healthBar').style.width = `${(healthAvg / 10) * 100}%`;
            document.getElementById('wealthBar').style.width = `${(wealthAvg / 10) * 100}%`;
            document.getElementById('loveBar').style.width = `${(loveAvg / 10) * 100}%`;

            // Generate summary text
            const summary = generateSummaryText(weekEntries, healthAvg, wealthAvg, loveAvg);
            document.getElementById('summaryText').textContent = summary;

            // Display daily entries
            displayDailyEntries(weekEntries);
        }

        function generateSummaryText(entries, healthAvg, wealthAvg, loveAvg) {
            const categories = [
                { name: 'health', avg: healthAvg, high: healthAvg >= 7, low: healthAvg <= 4 },
                { name: 'wealth', avg: wealthAvg, high: wealthAvg >= 7, low: wealthAvg <= 4 },
                { name: 'love', avg: loveAvg, high: loveAvg >= 7, low: loveAvg <= 4 }
            ];

            const highCategories = categories.filter(c => c.high).map(c => c.name);
            const lowCategories = categories.filter(c => c.low).map(c => c.name);

            let summary = `This week you journaled ${entries.length} ${entries.length === 1 ? 'day' : 'days'}. `;

            if (highCategories.length > 0) {
                summary += `You felt strongest in ${highCategories.join(' and ')}, `;
            }

            if (lowCategories.length > 0) {
                summary += `while ${lowCategories.join(' and ')} ${lowCategories.length === 1 ? 'was' : 'were'} more challenging. `;
            } else {
                summary += 'maintaining good balance across all areas. ';
            }

            // Add insight based on entries
            const commonWords = extractCommonThemes(entries);
            if (commonWords.length > 0) {
                summary += `Your reflections often mentioned ${commonWords.slice(0, 2).join(' and ')}, showing these were important themes for you this week.`;
            }

            return summary;
        }

        function extractCommonThemes(entries) {
            const allWords = entries
                .map(entry => entry.text.toLowerCase())
                .join(' ')
                .split(/\W+/)
                .filter(word => word.length > 3 && !['this', 'that', 'with', 'have', 'been', 'were', 'from', 'they', 'will', 'said', 'each', 'which', 'their', 'time', 'about'].includes(word));

            const wordCount = {};
            allWords.forEach(word => {
                wordCount[word] = (wordCount[word] || 0) + 1;
            });

            return Object.entries(wordCount)
                .filter(([word, count]) => count > 1)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(([word]) => word);
        }

        function displayDailyEntries(entries) {
            const container = document.getElementById('dailyEntries');
            const entriesHtml = entries
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(entry => {
                    const date = new Date(entry.date);
                    const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                    const dayDate = date.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric' });
                    
                    return `
                        <div class="daily-entry">
                            <div class="entry-date">${dayName} ${dayDate} ${entry.emoji || ''}</div>
                            <div class="entry-text">"${entry.text}"</div>
                            <div class="entry-ratings">
                                Health: ${entry.health}/10 ‚Ä¢ Wealth: ${entry.wealth}/10 ‚Ä¢ Love: ${entry.love}/10
                            </div>
                        </div>
                    `;
                })
                .join('');

            container.innerHTML = `
                <h3>Daily Snapshots</h3>
                ${entriesHtml}
            `;
        }

        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üåü DOM loaded, starting app...');
            initApp();
        });

        // Also try window load as backup
        window.addEventListener('load', () => {
            console.log('üåü Window loaded, ensuring app started...');
            // Only init if not already done
            if (!auth.currentUser && authScreen.classList.contains('hidden')) {
                initApp();
            }
        });
    </script>
</body>
</html>
